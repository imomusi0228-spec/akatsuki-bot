<style>
    .accordion-item {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 12px;
        background: rgba(255, 255, 255, 0.02);
    }

    .accordion-header {
        padding: 14px 20px;
        background: rgba(255, 255, 255, 0.03);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        transition: background 0.2s;
    }

    .accordion-header:hover {
        background: rgba(255, 255, 255, 0.07);
    }

    .accordion-content {
        padding: 20px;
        display: none;
        border-top: 1px solid var(--border-color);
        background: var(--card-bg);
    }

    .accordion-item.active .accordion-content {
        display: block;
    }

    .accordion-item.active .accordion-header {
        background: rgba(29, 155, 240, 0.1);
        color: var(--accent-color);
    }

    .ng-item {
        display: inline-flex;
        align-items: center;
        background: rgba(244, 33, 46, 0.1);
        color: #f4212e;
        border: 1px solid rgba(244, 33, 46, 0.2);
        padding: 4px 12px;
        border-radius: 20px;
        margin: 4px;
        font-size: 13px;
    }

    .ng-item button {
        background: none;
        border: none;
        color: #f4212e;
        margin-left: 8px;
        cursor: pointer;
        font-weight: bold;
        padding: 0 4px;
    }

    .help-icon {
        color: var(--text-secondary);
        cursor: help;
        font-size: 14px;
        margin-left: 6px;
    }
</style>

<div class="card" style="max-width: 1000px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0;">
            <%= t("settings") %>
        </h3>
        <span id="saveStatus" style="font-size:14px; font-weight:bold;"></span>
    </div>

    <!-- 1. Server Selector -->
    <div class="setting-section" style="margin-bottom:24px;">
        <label class="muted">Select Server</label>
        <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
            <select id="guild" style="flex:1;"></select>
            <button id="reload" class="btn">Reload</button>
        </div>
        <div id="guildStatus" style="font-size:12px; margin-top:4px;"></div>
    </div>

    <!-- ACCORDION START -->
    <div id="settings-accordion">

        <!-- 2. NG Words -->
        <div class="accordion-item active" id="sec-ng">
            <div class="accordion-header" onclick="toggleAccordion('sec-ng')">
                <span>ğŸš« <%= t("feature_ng_limit") %><span class="help-tip"
                            data-tip="<%= t('help_ng_limit') %>">?</span> <span id="ngCount" class="muted"
                            style="margin-left:10px; font-weight: normal;">0 <%= t("words") %></span></span>
                <span>â–¼</span>
            </div>
            <div class="accordion-content">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input id="newWord" type="text" placeholder="Add word..." style="flex:1;">
                    <button onclick="addNg()" class="btn btn-primary">+</button>
                </div>
                <div id="ngList" style="background:rgba(0,0,0,0.2); border-radius:8px; padding:10px; min-height:60px;">
                </div>
                <p class="muted" style="margin-top:10px; font-size:11px; margin-bottom: 20px;">â€»ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã§å›²ã‚€ã¨æ­£è¦è¡¨ç¾ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™
                    (ä¾‹: /badword/i)</p>

                <!-- Relocated NG Actions -->
                <div style="border-top: 1px solid var(--border-color); padding-top: 20px;">
                    <h4 style="margin: 0 0 15px 0; font-size: 14px; color: var(--accent-color);">
                        <%= t("ng_word_settings") %>
                    </h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <label class="muted">
                                <%= t("ng_threshold") %>
                            </label><br />
                            <input id="threshold" type="number" min="1" max="100" style="width:100%; margin-top:5px;">
                        </div>
                        <div>
                            <label class="muted">
                                <%= t("timeout_minutes") %><span class="help-tip"
                                        data-tip="<%= t('help_timeout') %>">?</span>
                            </label><br />
                            <input id="timeout" type="number" min="1" max="1440" style="width:100%; margin-top:5px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Anti-Raid -->
        <div class="accordion-item" id="sec-raid">
            <div class="accordion-header" onclick="toggleAccordion('sec-raid')">
                <span>ğŸ›¡ï¸ <%= t("anti_raid_settings") %><span class="help-tip"
                            data-tip="<%= t('help_antiraid') %>">?</span></span>
                <span>â–¼</span>
            </div>
            <div class="accordion-content">
                <div style="margin-bottom:15px;">
                    <label style="display:flex; align-items:center; cursor:pointer;">
                        <input type="checkbox" id="antiraidEnabled" style="width:18px; height:18px; margin-right:10px;">
                        <span style="font-weight: bold;">ã‚¢ãƒ³ãƒãƒ»ãƒ¬ã‚¤ãƒ‰ä¿è­·ã‚’æœ‰åŠ¹åŒ–</span>
                    </label>
                </div>
                <div>
                    <label class="muted">
                        <%= t("antiraid_threshold") %>
                    </label><br />
                    <input id="antiraidThreshold" type="number" min="1" max="1000"
                        style="width:100%; max-width: 300px; margin-top:5px;">
                </div>
            </div>
        </div>

        <!-- 4. Self Introduction Gate -->
        <div class="accordion-item" id="sec-intro">
            <div class="accordion-header" onclick="toggleAccordion('sec-intro')">
                <span>ğŸ“ <%= t("roadmap_introgate") %><span class="help-tip"
                            data-tip="<%= t('help_introgate') %>">?</span></span>
                <span>â–¼</span>
            </div>
            <div class="accordion-content">
                <div style="margin-bottom:15px;">
                    <label style="display:flex; align-items:center; cursor:pointer;">
                        <input type="checkbox" id="introGateEnabled"
                            style="width:18px; height:18px; margin-right:10px;">
                        <span>è‡ªå·±ç´¹ä»‹ã‚²ãƒ¼ãƒˆã‚’æœ‰åŠ¹åŒ–</span>
                    </label>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div>
                        <label class="muted">ä»˜ä¸ã™ã‚‹ãƒ­ãƒ¼ãƒ«</label><br />
                        <select id="introRole" style="width:100%; margin-top:5px;"></select>
                    </div>
                    <div>
                        <label class="muted">å¿…è¦æœ€å°æ–‡å­—æ•°</label><br />
                        <input id="introMinLen" type="number" min="1" value="10" style="width:100%; margin-top:5px;">
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. Channels -->
        <div class="accordion-item" id="sec-ch">
            <div class="accordion-header" onclick="toggleAccordion('sec-ch')">
                <span>ğŸ“¢ <%= t("log_settings") %></span>
                <span>â–¼</span>
            </div>
            <div class="accordion-content">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div>
                        <label class="muted">
                            <%= t("vc_log_ch") %>
                        </label><br />
                        <select id="logCh" style="width:100%; margin-top:5px;"></select>
                    </div>
                    <div>
                        <label class="muted">
                            <%= t("ng_log_ch") %>
                        </label><br />
                        <select id="ngLogCh" style="width:100%; margin-top:5px;"></select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. VC Related (Roles & Reports) -->
        <div class="accordion-item" id="sec-vc">
            <div class="accordion-header" onclick="toggleAccordion('sec-vc')">
                <span>ğŸ¤ VCé«˜åº¦è¨­å®š (Roles & Reports)</span>
                <span>â–¼</span>
            </div>
            <div class="accordion-content">
                <!-- Role Rules -->
                <div style="margin-bottom:24px;">
                    <label class="muted" style="display:block; margin-bottom:10px;">VCæ´»å‹•æ™‚é–“ã«å¿œã˜ãŸã‚ªãƒ¼ãƒ©ä»˜ä¸ï¼ˆåç§°ã¨æ™‚é–“ï¼‰<span
                            class="help-tip" data-tip="<%= t('help_vc_role') %>">?</span></label>
                    <div id="roleRulesList" style="display:flex; flex-direction:column; gap:8px; margin-bottom:10px;">
                    </div>
                    <button type="button" onclick="addRoleRule()" class="btn" style="font-size:12px; width:100%;">+
                        ã‚ªãƒ¼ãƒ©ã‚’è¿½åŠ </button>

                </div>

                <!-- Reports -->
                <div style="border-top:1px solid var(--border-color); padding-top:20px;">
                    <label style="display:flex; align-items:center; cursor:pointer; margin-bottom:15px;">
                        <input type="checkbox" id="vcReportEnabled" style="width:18px; height:18px; margin-right:10px;">
                        <span>VCã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£é€±å ±ã‚’æœ‰åŠ¹åŒ–<span class="help-tip"
                                data-tip="<%= t('help_vc_report') %>">?</span></span>
                    </label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <label class="muted">ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡å…ˆ</label><br />
                            <select id="vcReportCh" style="width:100%; margin-top:5px;"></select>
                        </div>
                        <div>
                            <label class="muted">é€ä¿¡é–“éš”</label><br />
                            <select id="vcReportInterval" style="width:100%; margin-top:5px;">
                                <option value="daily">æ¯æ—¥</option>
                                <option value="weekly" selected>æ¯é€±</option>
                                <option value="monthly">æ¯æœˆ</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 7. AI Community Health Radar -->
        <div class="accordion-item" id="sec-ai">
            <div class="accordion-header" onclick="toggleAccordion('sec-ai')">
                <span>ğŸ¤– ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ»ãƒ˜ãƒ«ã‚¹ãƒ»ãƒ¬ãƒ¼ãƒ€ãƒ¼ (AIã‚¢ãƒ‰ãƒã‚¤ã‚¹)</span>
                <span>â–¼</span>
            </div>
            <div class="accordion-content">
                <p class="muted" style="font-size:12px; margin-bottom:15px;">
                    ä¸€å®šæœŸé–“æ´»å‹•ã®ãªã„ãƒ¡ãƒ³ãƒãƒ¼ã«å¯¾ã—ã€AIï¼ˆãƒœãƒƒãƒˆï¼‰ãŒä¸å¯§ãªå£èª¿ã§ã€Œæ¥ã—æ–¹ã€ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’é€ã‚Šã¾ã™ã€‚</p>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div>
                        <label class="muted">ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡Œã†æ”¾ç½®æ—¥æ•°</label><br />
                        <input id="aiAdviceDays" type="number" min="1" value="14" style="width:100%; margin-top:5px;">
                    </div>
                    <div>
                        <label class="muted">ã‚¢ãƒ‰ãƒã‚¤ã‚¹é€šçŸ¥å…ˆ</label><br />
                        <select id="aiAdviceCh" style="width:100%; margin-top:5px;"></select>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- ACCORDION END -->


    <div style="margin-top:30px; display:flex; gap:15px;">
        <button id="save" class="btn btn-primary" style="flex:1; padding:12px; font-size:16px;">
            <%= t("save_settings") %>
        </button>
    </div>
</div>

<script src="/js/dashboard.js"></script>
<script>initSettings();</script>