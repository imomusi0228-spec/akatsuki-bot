<style>
    .guard-selector {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        justify-content: center;
    }

    .guard-card {
        flex: 1;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid var(--border-color);
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: rgba(255, 255, 255, 0.02);
        max-width: 250px;
    }

    .guard-card:hover {
        transform: translateY(-4px);
        background: rgba(255, 255, 255, 0.05);
    }

    .guard-card.active {
        border-color: var(--status-color);
        background: var(--status-bg);
        box-shadow: 0 0 20px var(--status-shadow);
    }

    .guard-icon {
        font-size: 32px;
        margin-bottom: 10px;
        display: block;
    }

    .guard-name {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
    }

    .guard-desc {
        font-size: 11px;
        color: var(--text-secondary);
        line-height: 1.4;
    }

    .guard-green {
        --status-color: #00ba7c;
        --status-bg: rgba(0, 186, 124, 0.1);
        --status-shadow: rgba(0, 186, 124, 0.2);
    }

    .guard-yellow {
        --status-color: #ffd400;
        --status-bg: rgba(255, 212, 0, 0.1);
        --status-shadow: rgba(255, 212, 0, 0.2);
    }

    .guard-red {
        --status-color: #f4212e;
        --status-bg: rgba(244, 33, 46, 0.1);
        --status-shadow: rgba(244, 33, 46, 0.2);
    }

    .antiraid-section {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
    }

    .antiraid-section h4 {
        margin: 0 0 15px 0;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--accent-color);
    }
</style>

<div class="card" style="max-width: 1000px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
        <h3 style="margin:0;">ğŸ›¡ï¸ <%= t("nav_antiraid") %>
        </h3>
        <span id="saveStatus" style="font-size:14px; font-weight:bold;"></span>
    </div>

    <!-- 1. Server Selector -->
    <div class="setting-section" style="margin-bottom:24px;">
        <label class="muted">Select Server</label>
        <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
            <select id="guild" style="flex:1;"></select>
            <button id="reload" class="btn">Reload</button>
        </div>
    </div>

    <!-- 2. Guard Mode Selector -->
    <div class="guard-selector">
        <div class="guard-card guard-green" id="guard-0" onclick="setGuard(0)">
            <span class="guard-icon">ğŸŸ¢</span>
            <span class="guard-name">é€šå¸¸ (Normal)</span>
            <span class="guard-desc">æ¨™æº–çš„ãªç›£è¦–ã¨NGãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥ã®ã¿ã‚’è¡Œã„ã¾ã™ã€‚</span>
        </div>
        <div class="guard-card guard-yellow" id="guard-1" onclick="setGuard(1)">
            <span class="guard-icon">ğŸŸ¡</span>
            <span class="guard-name">è­¦æˆ’ (Caution)</span>
            <span class="guard-desc">æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ¶é™ã‚’å¼·åŒ–ã—ã€ä¸å¯©ãªãƒªãƒ³ã‚¯ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™ã€‚</span>
        </div>
        <div class="guard-card guard-red" id="guard-2" onclick="setGuard(2)">
            <span class="guard-icon">ğŸ”´</span>
            <span class="guard-name">é˜²è¡› (Lockdown)</span>
            <span class="guard-desc">è‡ªå‹•ãƒ­ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã€éš”é›¢ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚</span>
        </div>
    </div>

    <div id="antiraid-settings" style="display: none;">
        <!-- 3. Rapid Join Detection -->
        <div class="antiraid-section">
            <h4>ğŸš€ æ€¥å¢—å‚åŠ æ¤œçŸ¥ (Rapid Join)</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <label class="muted">æ¤œçŸ¥ã—ãã„å€¤ (åˆ†é–“å‚åŠ æ•°)</label>
                    <input id="raidThreshold" type="number" value="10" min="1" style="width:100%; margin-top:5px;">
                </div>
                <div>
                    <label class="muted">è¶…éæ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</label>
                    <select id="raidAction" style="width:100%; margin-top:5px;">
                        <option value="none">è­¦å‘Šã®ã¿</option>
                        <option value="caution">è­¦æˆ’ãƒ¢ãƒ¼ãƒ‰ã¸ç§»è¡Œ</option>
                        <option value="lockdown">é˜²è¡›ãƒ¢ãƒ¼ãƒ‰(ãƒ­ãƒƒã‚¯)ã¸å®Ÿè¡Œ</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 4. Newcomer Restrictions -->
        <div class="antiraid-section">
            <h4>ğŸ‘¶ æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼åˆ¶é™ (Newcomer)</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <label class="muted">ç™ºè¨€ç¦æ­¢æ™‚é–“ (åˆ†)</label>
                    <input id="newcomerRestrictMins" type="number" value="10" min="0"
                        style="width:100%; margin-top:5px;">
                </div>
                <div>
                    <label class="muted">åˆ¶é™å¯¾è±¡ã‚¢ã‚«ä½œæˆæ—¥ (æ—¥å‰)</label>
                    <input id="newcomerAccountAge" type="number" value="1" min="0" style="width:100%; margin-top:5px;">
                </div>
            </div>
            <p class="muted" style="margin-top:10px; font-size:11px;">â€»ã€Œé˜²è¡›ã€ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ã€ãƒ­ãƒ¼ãƒ«ãŒä»˜ä¸ã•ã‚Œã‚‹ã¾ã§è‡ªå‹•çš„ã«åˆ¶é™ã•ã‚Œã¾ã™ã€‚</p>
        </div>

        <!-- 5. Link & Content Filter -->
        <div class="antiraid-section">
            <h4>ğŸ”— é«˜åº¦ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h4>
            <div style="margin-bottom:15px;">
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="linkBlockEnabled" style="width:18px; height:18px; margin-right:10px;">
                    <span>æ‹›å¾…ãƒªãƒ³ã‚¯ãƒ»ä¸å¯©ãªãƒªãƒ³ã‚¯ã‚’è‡ªå‹•å‰Šé™¤</span>
                </label>
            </div>
            <div>
                <label class="muted">ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
                <textarea id="domainBlacklist"
                    style="width:100%; min-height:60px; margin-top:5px; background:#000; color:#fff; border:1px solid var(--border-color); border-radius:6px; padding:10px;"></textarea>
            </div>
        </div>

        <!-- 6. Quarantine (Silent Processing) -->
        <div class="antiraid-section">
            <h4>â˜£ï¸ éš”é›¢è¨­å®š (Silent Processing)</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <label class="muted">éš”é›¢ç”¨ãƒ­ãƒ¼ãƒ« (Quarantine Role)</label>
                    <select id="quarantineRole" style="width:100%; margin-top:5px;"></select>
                </div>
                <div>
                    <label class="muted">éš”é›¢ãƒ­ã‚°ãƒãƒ£ãƒ³ãƒãƒ«</label>
                    <select id="quarantineChannel" style="width:100%; margin-top:5px;"></select>
                </div>
            </div>
            <p class="muted" style="margin-top:10px; font-size:11px;">â€»ã€Œé˜²è¡›ã€ãƒ¢ãƒ¼ãƒ‰ã§ã®æ¤œçŸ¥æ™‚ã€ã‚­ãƒƒã‚¯ã®ä»£ã‚ã‚Šã«ã“ã®ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸ã—ã€ãƒ­ã‚°ã¸èª˜å°ã—ã¾ã™ã€‚</p>
        </div>

        <button id="save" class="btn btn-primary" style="width:100%; padding:15px; font-size:18px; margin-top:10px;">
            è¦å¡è¨­å®šã‚’ä¿å­˜
        </button>
    </div>
</div>

<script src="/js/dashboard.js"></script>
<script>
    let currentGuardLevel = 0;
    function setGuard(level) {
        currentGuardLevel = level;
        document.querySelectorAll('.guard-card').forEach(c => c.classList.remove('active'));
        document.getElementById('guard-' + level).classList.add('active');
    }

    // Overload dashboard init for this page
    async function initAntiRaid() {
        if (!await loadGuilds()) return;
        document.getElementById('antiraid-settings').style.display = 'block';

        const selGuild = document.getElementById('guild');

        const reload = async () => {
            const gid = selGuild.value;
            if (!gid) return;

            // Load Masters (Roles/Channels)
            const [ch, rl, st] = await Promise.all([
                api("/api/channels?guild=" + gid),
                api("/api/roles?guild=" + gid),
                api("/api/settings?guild=" + gid)
            ]);

            const roles = rl.ok ? rl.roles : [];
            const channels = ch.ok ? ch.channels : [];

            // Populate Dropdowns
            const qRole = document.getElementById('quarantineRole');
            const qChan = document.getElementById('quarantineChannel');

            qRole.innerHTML = '<option value="">(None)</option>';
            roles.forEach(r => {
                const o = document.createElement('option'); o.value = r.id; o.textContent = r.name; qRole.appendChild(o);
            });

            qChan.innerHTML = '<option value="">(None)</option>';
            channels.forEach(c => {
                const o = document.createElement('option'); o.value = c.id; o.textContent = '#' + c.name; qChan.appendChild(o);
            });

            // Load Settings
            if (st.ok && st.settings) {
                const s = st.settings;
                setGuard(s.antiraid_guard_level || 0);
                document.getElementById('raidThreshold').value = s.raid_join_threshold || 10;
                document.getElementById('newcomerRestrictMins').value = s.newcomer_restrict_mins || 10;
                document.getElementById('newcomerAccountAge').value = s.newcomer_min_account_age || 1;
                document.getElementById('linkBlockEnabled').checked = s.link_block_enabled;
                document.getElementById('domainBlacklist').value = (s.domain_blacklist || []).join(', ');
                document.getElementById('quarantineRole').value = s.quarantine_role_id || "";
                document.getElementById('quarantineChannel').value = s.quarantine_channel_id || "";
            }
        };

        document.getElementById('save').onclick = async () => {
            const body = {
                guild: selGuild.value,
                antiraid_guard_level: currentGuardLevel,
                raid_join_threshold: parseInt(document.getElementById('raidThreshold').value),
                newcomer_restrict_mins: parseInt(document.getElementById('newcomerRestrictMins').value),
                newcomer_min_account_age: parseInt(document.getElementById('newcomerAccountAge').value),
                link_block_enabled: document.getElementById('linkBlockEnabled').checked,
                domain_blacklist: document.getElementById('domainBlacklist').value.split(',').map(s => s.trim()).filter(s => s),
                quarantine_role_id: document.getElementById('quarantineRole').value,
                quarantine_channel_id: document.getElementById('quarantineChannel').value
            };

            const res = await api("/api/settings/update", body);
            if (res.ok) {
                alert("è¦å¡ã®é˜²è¡›è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚");
                document.getElementById('saveStatus').textContent = "Saved";
            } else {
                alert("Error: " + res.error);
            }
        };

        selGuild.onchange = reload;
        document.getElementById('reload').onclick = reload;
        reload();
    }
    initAntiRaid();
</script>